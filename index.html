<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Word Puzzle - Ë∂£Âë≥Êé¢Á¥¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<style>
:root {
    /* --- Ê∏∏ÊàèÂåñÈÖçËâ≤ÊñπÊ°à --- */
    --bg-color: #FFF3E0;
    --primary-color: #7B61FF;
    --primary-dark: #5E4AD3;
    
    --text-brown: #333333;
    --text-light: #FFF;
    
    --card-base: #FFFFFF;
    --card-shadow: #E0E0E0;
    
    --board-bg: #FFFFFF;
    --board-border: #FFCC80;
    
    --item-height: 52px;
    --item-min-width: 110px;
    --item-radius: 16px;
    
    --current-theme: #7B61FF; 
}

body {
    font-family: 'Varela Round', 'YouYuan', 'ÂπºÂúÜ', 'Microsoft YaHei', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    user-select: none;
    color: var(--text-brown);
}

.hidden { display: none !important; }
.fade-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes popIn {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

/* --- 1. ‰∏ªÈ°µÊ†∑Âºè --- */
#home-view {
    max-width: 900px;
    margin: 0 auto;
    /* È°∂ÈÉ®ÁïôÁôΩËæÉÂ∞èÔºåÁ°Æ‰øùÂÜÖÂÆπÈù†‰∏ä */
    padding: 0px 20px 40px 20px; 
}

.header-section {
    text-align: center;
    margin-bottom: 30px; 
    margin-top: 30px;
    position: relative;
    animation: float 4s ease-in-out infinite;
}

.app-title {
     font-family: 'Fredoka One', cursive;
    font-size: 3.8rem;
    color: var(--primary-color);
    margin-bottom: 16px;
    font-weight: 900;
    letter-spacing: 2px;
}

/* ÊÄªÊòüÊòüËÉ∂ÂõäÊ†∑Âºè */
.total-star-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #FFF;
    padding: 0 28px;
    height: 48px;
    border-radius: 50px;
    box-shadow: 0 6px 0 #FFE0B2, 0 10px 10px rgba(0,0,0,0.1);
    gap: 12px;
    border: 3px solid #FFCC80;
    transition: transform 0.2s;
}
.total-star-badge:hover { transform: scale(1.05) translateY(-2px); }

.total-star-icon {
    width: 34px; height: 34px; 
    fill: #FFD700;
    overflow: visible; 
    display: block;
}
.total-star-count {
    font-size: 1.8rem; 
    font-weight: 900; 
    color: #F57F17;
    line-height: 1; 
    position: relative;
    top: 2px;
}

.level-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 30px;
    padding-bottom: 40px;
}

.level-card {
    background: white;
    border-radius: 28px;
    padding: 0;
    cursor: pointer;
    position: relative;
    box-shadow: 0 8px 0 #E0E0E0, 0 12px 20px rgba(0,0,0,0.1);
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 3px solid #FFF;
    overflow: hidden;
    display: flex; flex-direction: column;
}

.level-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 0 #E0E0E0, 0 20px 30px rgba(0,0,0,0.15);
}
.level-card:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #E0E0E0, 0 4px 10px rgba(0,0,0,0.1);
}

.card-header-bg {
    background-color: var(--level-bg-alpha);
    padding: 20px 24px 12px 24px;
    border-bottom: 2px dashed rgba(0,0,0,0.05);
}

.card-header-row {
    display: flex; justify-content: space-between; align-items: center;
}

.card-title {
    font-size: 1.6rem; font-weight: 900; color: var(--text-brown); margin: 0;
}

.card-tag {
    font-size: 0.9rem; padding: 6px 14px; border-radius: 20px;
    font-weight: 600;
    background-color: #FFF; color: var(--level-color);
    box-shadow: 0 3px 0 rgba(0,0,0,0.05);
}

.card-body {
    padding: 15px 24px 20px 24px;
    display: flex; flex-direction: column; gap: 15px;
}

.preview-words {
    font-size: 1rem; color: #90A4AE; font-weight: 600;
    background: #F5F7F8; padding: 8px 12px; border-radius: 12px;
}

.card-footer {
    display: flex; justify-content: space-between; align-items: center;
}

.card-stars { display: flex; gap: 5px; }
.rounded-star {
    width: 28px; height: 28px; fill: #ECEFF1;
    overflow: visible; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.rounded-star.earned { 
    fill: #FFD700; transform: scale(1.15); 
    filter: drop-shadow(0 2px 0 #F9A825);
}
.rounded-star path { stroke-linejoin: round; stroke-width: 3; stroke: inherit; }

.play-icon {
    width: 36px; height: 36px; background: var(--level-color);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; 
}

/* --- 2. Ê∏∏ÊàèÈ°µÊ†∑Âºè --- */
#game-view {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: var(--bg-color);
    z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 0; overflow: hidden;
}

.game-header {
    width: 90%; max-width: 850px; flex-shrink: 0;
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
}

.btn-3d {
    border: none; outline: none; cursor: pointer;
    font-family: inherit; font-weight: 800;
    transition: all 0.1s; position: relative;
    user-select: none;
}
.btn-3d:active { transform: translateY(4px) !important; box-shadow: 0 0 0 transparent !important; }

.back-btn {
    background: #FFF; padding: 10px 24px; border-radius: 50px;
    color: #555; font-size: 1.1rem;
    box-shadow: 0 5px 0 #CFD8DC, 0 10px 10px rgba(0,0,0,0.1);
    display: flex; align-items: center; gap: 8px; border: 2px solid #ECEFF1;
}

.current-level-title {
    font-size: 2.2rem; font-weight: 900; 
    color: var(--text-brown) !important;
    text-shadow: 2px 2px 0 #FFF;
}

.game-board {
    position: relative; background: #FFF; padding: 20px;
    border-radius: 36px;
    box-shadow: 0 15px 0 rgba(0,0,0,0.05), 0 30px 50px rgba(0,0,0,0.1);
    width: 90%; max-width: 850px; max-height: 88vh;
    display: flex; flex-direction: column; align-items: center;
    border: 6px solid var(--board-border);
    overflow: hidden;
}

.scene-wrapper {
    position: relative; width: 100%; border-radius: 24px; overflow: hidden;
    background: #F4F8FB; aspect-ratio: 16/9;
    max-height: 52vh; 
    box-shadow: inset 0 0 20px rgba(0,0,0,0.05); margin-bottom: 20px;
    border: 3px solid #ECEFF1;
}

.scene-image { width: 100%; height: 100%; object-fit: contain; display: block; }

.hint-btn {
    position: absolute; top: 20px; right: 20px;
    background: #FFF; border: 3px solid #FFCDD2;
    border-radius: 50px; padding: 8px 20px;
    color: #E57373; font-size: 1rem;
    box-shadow: 0 4px 0 #FFCDD2; z-index: 20;
    display: flex; align-items: center; gap: 6px;
}

/* --- ÊãñÊãΩÁõÆÊ†áÊ°Ü --- */
.drop-target {
    position: absolute; transform: translate(-50%, -50%);
    min-width: var(--item-min-width); height: var(--item-height);
    background: rgba(0, 0, 0, 0.1);
    border: 3px dashed rgba(255,255,255,0.8);
    box-shadow: inset 0 3px 6px rgba(0,0,0,0.1);
    border-radius: var(--item-radius);
    display: flex; justify-content: center; align-items: center;
    transition: all 0.3s; z-index: 10; box-sizing: border-box;
}
.drop-target::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    width: 6px; height: 6px; background: #FFF; border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-top: 8px;
    border: 2px solid var(--current-theme);
}
.drop-target.hovered {
    background: rgba(255, 255, 255, 0.4);
    transform: translate(-50%, -50%) scale(1.1);
    border-color: #FFF;
    box-shadow: 0 0 20px rgba(255,255,255,0.6);
}

.drop-target.filled {
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
}
.drop-target.filled::after { display: none; }


/* --- ËØçËØ≠Âç°Áâá‰∏éËØçÂ∫ì --- */
.word-bank {
    display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;
    padding: 5px; width: 100%; 
    height: 140px; 
    align-content: flex-start; 
    overflow-y: visible;
}

.word-card {
    background: white;
    min-width: var(--item-min-width); height: var(--item-height);
    padding: 0 20px; box-sizing: border-box;
    border-radius: var(--item-radius);
    display: flex; justify-content: center; align-items: center;
    font-weight: 700; font-size: 1.2rem; color: #546E7A;
    border: 2px solid #ECEFF1;
    border-bottom-width: 2px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: grab; position: relative;
    user-select: none;
}

.word-card::before {
    content: ''; display: inline-block; width: 10px; height: 10px;
    border-radius: 50%; background-color: var(--current-theme);
    margin-right: 8px; box-shadow: inset 0 2px 2px rgba(0,0,0,0.1);
    transition: background-color 0.2s;
}

.word-card:hover, .word-card:active {
    background-color: #FFF;
    border-color: var(--current-theme);
    color: var(--current-theme);
    transform: translateY(-4px);
    box-shadow: 0 8px 16px var(--current-theme-alpha);
}

.word-card:hover::before, .word-card:active::before {
    background-color: var(--current-theme);
}

.word-card:active { cursor: grabbing; }

.word-card.placed {
    cursor: default; 
    width: 100%; height: 100%;
    background: var(--current-theme);
    color: white; border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    animation: jellyBounce 0.5s;
    border-radius: var(--item-radius);
    font-size: 1.4rem;
}
.word-card.placed::before { display: none; }


@keyframes pulseTarget {
    0% { transform: translate(-50%, -50%) scale(1); border-color: #FF5252; box-shadow: 0 0 0 rgba(255,82,82,0); }
    50% { transform: translate(-50%, -50%) scale(1.2); border-color: #FF5252; box-shadow: 0 0 15px rgba(255,82,82,0.6); }
    100% { transform: translate(-50%, -50%) scale(1); border-color: #FF5252; box-shadow: 0 0 0 rgba(255,82,82,0); }
}

@keyframes pulseCard {
    0% { transform: scale(1); border-color: #FF5252; }
    50% { transform: scale(1.1); border-color: #FF5252; background-color: #FFEBEE; }
    100% { transform: scale(1); border-color: #CFD8DC; }
}

.drop-target.hint-target {
    animation: pulseTarget 1s infinite;
    z-index: 999; 
    background: rgba(255, 255, 255, 0.5) !important;
}

.word-card.hint-target {
    animation: pulseCard 1s infinite;
}

/* ÂºπÁ™óÊ†∑Âºè */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
    display: none; justify-content: center; align-items: center; z-index: 1000;
}
.modal-card {
    background: #FFF; padding: 40px; border-radius: 40px; text-align: center;
    max-width: 420px; 
    width: 90%;
    box-shadow: 0 20px 0 rgba(0,0,0,0.1), 0 40px 80px rgba(0,0,0,0.3);
    border: 5px solid #FFF;
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    display: flex; flex-direction: column;
}
.modal-card::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 600px; height: 600px; background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
    z-index: -1; pointer-events: none;
}

.star-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-shrink: 0; }

.star-box { 
    width: 80px; height: 80px; 
    opacity: 1; 
    transform: scale(1); 
    transition: all 0.3s;
}
.star-svg { 
    width: 100%; height: 100%; 
    fill: #ECEFF1; 
    overflow: visible; 
    filter: none;
}
.star-box.active .star-svg {
    fill: #FFD700;
    filter: drop-shadow(0 4px 0 #F57F17);
}
.star-box.active {
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modal-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-shrink: 0; }
.btn-primary { 
    background: var(--primary-color); color: white; padding: 14px 30px; border-radius: 50px; font-size: 1.2rem;
    box-shadow: 0 6px 0 var(--primary-dark); 
}
.btn-secondary {
    background: #CFD8DC; color: #546E7A; padding: 14px 30px; border-radius: 50px; font-size: 1.2rem;
    box-shadow: 0 6px 0 #B0BEC5;
}

/* ÂçïËØçÂàóË°®Ê†∑Âºè */
.level-word-list {
    background: #F4F8FB;
    border-radius: 20px;
    padding: 15px 20px;
    margin: 10px 0 15px 0;
    max-height: 180px;
    overflow-y: auto;
    border: 2px solid #ECEFF1;
    text-align: left;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.03);
}

.level-word-list::-webkit-scrollbar { width: 6px; }
.level-word-list::-webkit-scrollbar-thumb { background-color: #CFD8DC; border-radius: 10px; }
.level-word-list::-webkit-scrollbar-track { background: transparent; }

.word-list-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #DEE4E7;
    font-size: 1.05rem;
}
.word-list-item:last-child { border-bottom: none; }
.word-en { font-weight: 800; color: var(--primary-color); }
.word-cn { font-weight: 500; color: #78909C; }


@keyframes jellyBounce { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
@keyframes wrongShake { 0%, 100% { transform: translate(-50%, -50%); } 20%, 60% { transform: translate(-55%, -50%); } 40%, 80% { transform: translate(-45%, -50%); } }
.wrong-shake { animation: wrongShake 0.4s; border-color: #FF5252 !important; }

@media (max-width: 600px) {
    .app-title { font-size: 3.2rem; }
    .level-grid { grid-template-columns: 1fr; }
    .scene-wrapper { max-height: 45vh; }
    .modal-buttons { flex-direction: column; width: 100%; }
    .btn-3d { width: 100%; }
}
</style>
</head>
<body>

<div id="home-view" class="fade-in">
    <div class="header-section">
        <div class="app-title">Word Puzzle</div>
        <div class="total-star-badge">
            <svg class="total-star-icon" viewBox="-2 -2 28 28">
                <path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z" />
                <circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/> 
            </svg>
            <span id="total-stars-count" class="total-star-count">0</span>
        </div>
    </div>
    <div class="level-grid" id="level-grid"></div>
</div>

<div id="game-view" class="hidden">
    <header class="game-header">
        <button class="back-btn btn-3d" onclick="goHome()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            ËøîÂõû
        </button>
        <div class="current-level-title" id="level-title-display">Âú∫ÊôØÂêçÁß∞</div>
        <div style="width: 80px;"></div> 
    </header>

    <main class="game-board">
        <button class="hint-btn btn-3d" onclick="useHint()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548 5.474a3 3 0 0 1-2.988 2.986h0a3 3 0 0 1-2.988-2.986l-.548-5.474z"/></svg>
            ÊèêÁ§∫
        </button>
        <div class="scene-wrapper">
            <img src="" id="game-image" class="scene-image" alt="Scene">
            <div id="drop-layer"></div>
        </div>
        <div class="word-bank" id="word-bank"></div>
    </main>
</div>

<div class="modal-overlay" id="win-modal">
    <div class="modal-card">
        <div class="star-container">
            <div class="star-box" id="star-1"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
            <div class="star-box" id="star-2"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
            <div class="star-box" id="star-3"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
        </div>
        
        <h2 style="font-size: 2.2rem; color: var(--primary-color); margin: 0 0 10px 0; font-weight:900;" id="modal-heading">ÈóØÂÖ≥ÊàêÂäü!</h2>
        <p style="color:#90A4AE; font: weight 500px; margin: 0 0 15px 0; font-size: 1.1rem;" id="modal-msg">‰Ω†ÁúüÊòØ‰∏™Â∞èÂ§©ÊâçÔºÅ</p>
        
        <div id="level-word-list" class="level-word-list"></div>

        <div class="modal-buttons">
            <button class="btn-3d btn-secondary" onclick="goHome()">ÈÄâÂÖ≥</button>
            <button class="btn-3d btn-primary" onclick="nextLevel()">‰∏ã‰∏ÄÂÖ≥</button>
        </div>
    </div>
</div>

<script>
const IMG_EXT = '.png';
const ROUNDED_STAR_PATH = "M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z";
const HIGHLIGHT_CIRCLE = '<circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/>';

const levels = {
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÊòÜËô´.png'ÔºåÊîπ‰∏∫ 'insects.png' (ÂØπÂ∫î key Âêç)
    insects: { name: 'ÂæÆËßÇ‰∏ñÁïå', theme: 'Â•áÂ¶ôÊòÜËô´', img: `insects${IMG_EXT}`, color: '#AED581', items: [
       { id: 'lad', word: 'Ladybug', cn: 'Áì¢Ëô´', top: '40%', left: '15%' },
        { id: 'but', word: 'Butterfly', cn: 'Ëù¥Ëù∂', top: '30%', left: '50%' },
        { id: 'bee', word: 'Bee', cn: 'ËúúËúÇ', top: '35%', left: '75%' },
        { id: 'ant', word: 'Ant', cn: 'ËöÇËöÅ', top: '50%', left: '35%' },
         { id: 'dra', word: 'Dragonfly', cn: 'ËúªËúì', top: '50%', left: '65%' },
        { id: 'man', word: 'Mantis', cn: 'Ëû≥ËûÇ', top: '65%', left: '85%' },
        { id: 'spi', word: 'Spider', cn: 'ËúòËõõ', top: '85%', left: '20%' },
        { id: 'sna', word: 'Snail', cn: 'ËúóÁâõ', top: '90%', left: '50%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'È¢úËâ≤.png'ÔºåÊîπ‰∏∫ 'colors.png'
    colors: { name: 'Ëâ≤ÂΩ©ÂêØËíô', theme: 'Â§öÂΩ©È¢úÊñô', img: `colors${IMG_EXT}`, color: '#7986CB', items: [
        { id: 'blu', word: 'Blue', cn: 'ËìùËâ≤', top: '20%', left: '25%' },
        { id: 'yel', word: 'Yellow', cn: 'ÈªÑËâ≤', top: '20%', left: '50%' },
        { id: 'pur', word: 'Purple', cn: 'Á¥´Ëâ≤', top: '20%', left: '75%' },
        { id: 'red', word: 'Red', cn: 'Á∫¢Ëâ≤', top: '45%', left: '15%' },
        { id: 'gre', word: 'Green', cn: 'ÁªøËâ≤', top: '45%', left: '42%' },
        { id: 'bro', word: 'Brown', cn: 'Ê£ïËâ≤', top: '40%', left: '90%' },
        { id: 'bla', word: 'Black', cn: 'ÈªëËâ≤', top: '75%', left: '30%' },
        { id: 'ora', word: 'Orange', cn: 'Ê©ôËâ≤', top: '70%', left: '65%' },
        { id: 'whi', word: 'White', cn: 'ÁôΩËâ≤', top: '65%', left: '88%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'È∏üÁ±ª.png'ÔºåÊîπ‰∏∫ 'birds.png'
    birds: { name: 'Â§©Á©∫Á≤æÁÅµ', theme: 'ËÆ§ËØÜÈ∏üÁ±ª', img: `birds${IMG_EXT}`, color: '#4DD0E1', items: [
        { id: 'spa', word: 'Sparrow', cn: 'È∫ªÈõÄ', top: '20%', left: '15%' },
        { id: 'pig', word: 'Pigeon', cn: 'È∏ΩÂ≠ê', top: '20%', left: '40%' },
        { id: 'par', word: 'Parrot', cn: 'Èπ¶Èπâ', top: '25%', left: '60%' },
        { id: 'hum', word: 'Hummingbird', cn: 'ËúÇÈ∏ü', top: '15%', left: '85%' },
        { id: 'owl', word: 'Owl', cn: 'Áå´Â§¥Èπ∞', top: '65%', left: '32%' },
        { id: 'mag', word: 'Magpie', cn: 'ÂñúÈπä', top: '65%', left: '50%' },
        { id: 'woo', word: 'Woodpecker', cn: 'ÂïÑÊú®È∏ü', top: '60%', left: '85%' },
        { id: 'nes', word: 'Nest', cn: 'È∏üÂ∑¢', top: '75%', left: '15%' }
    ]},
    // ‚úÖ Âéü‰ª£Á†ÅÊ≠£Á°Æ (‰ΩøÁî®‰∫Ü animals${IMG_EXT})
    animals: { name: 'ÁÉ≠ÈóπÂä®Áâ©Âõ≠', theme: 'Ëá™ÁÑ∂ÁîüÁâ©', img: `animals${IMG_EXT}`, color: '#FF8A80', items: [
        { id: 'gir', word: 'Giraffe', cn: 'ÈïøÈ¢àÈπø', top: '30%', left: '15%' },
        { id: 'ele', word: 'Elephant', cn: 'Â§ßË±°', top: '35%', left: '45%' },
        { id: 'lio', word: 'Lion', cn: 'ÁãÆÂ≠ê', top: '75%', left: '80%' },
        { id: 'zeb', word: 'Zebra', cn: 'ÊñëÈ©¨', top: '70%', left: '25%' },
        { id: 'pan', word: 'Panda', cn: 'ÁÜäÁå´', top: '85%', left: '50%' },
        { id: 'mon', word: 'Monkey', cn: 'Áå¥Â≠ê', top: '20%', left: '80%' },
        { id: 'tre', word: 'Tree', cn: 'Ê†ë', top: '60%', left: '60%' }
    ]},
    // ‚úÖ Âéü‰ª£Á†ÅÊ≠£Á°Æ
    marine: { name: 'Â•áÂπªÊµ∑Ê¥ãÈ¶Ü', theme: 'Ê∑±Êµ∑Êé¢Áßò', img: `marine${IMG_EXT}`, color: '#4FC3F7', items: [
        { id: 'jel', word: 'Jellyfish', cn: 'Ê∞¥ÊØç', top: '20%', left: '60%' },
        { id: 'sta', word: 'Starfish', cn: 'Êµ∑Êòü', top: '25%', left: '35%' },
        { id: 'tur', word: 'Sea Turtle', cn: 'Êµ∑Èæü', top: '70%', left: '80%' },
        { id: 'cra', word: 'Crab', cn: 'ËûÉËüπ', top: '75%', left: '45%' },
        { id: 'fis', word: 'Fish', cn: 'È±º', top: '25%', left: '85%' },
        { id: 'she', word: 'Shell', cn: 'Ë¥ùÂ£≥', top: '25%', left: '15%' },
        { id: 'cor', word: 'Coral', cn: 'ÁèäÁëö', top: '75%', left: '15%' }
    ]},
    // ‚úÖ Âéü‰ª£Á†ÅÊ≠£Á°Æ
    fruit: { name: 'È≤úÁæéÊ∞¥ÊûúÊëä', theme: 'ÂÅ•Â∫∑È•ÆÈ£ü', img: `fruit${IMG_EXT}`, color: '#FFD54F', items: [
        { id: 'wat', word: 'Watermelon', cn: 'Ë•øÁìú', top: '50%', left: '50%' },
        { id: 'ban', word: 'Banana', cn: 'È¶ôËïâ', top: '85%', left: '14%' },
        { id: 'ora', word: 'Orange', cn: 'Ê©ôÂ≠ê', top: '75%', left: '30%' },
        { id: 'gra', word: 'Grape', cn: 'Ëë°ËêÑ', top: '65%', left: '70%' },
        { id: 'app', word: 'Apple', cn: 'ËãπÊûú', top: '50%', left: '15%' },
        { id: 'pin', word: 'Pineapple', cn: 'Ëè†Ëêù', top: '35%', left: '85%' },
        { id: 'lem', word: 'Lemon', cn: 'Êü†Ê™¨', top: '80%', left: '85%' },
        { id: 'str', word: 'Strawberry', cn: 'ËçâËéì', top: '80%', left: '50%' }
    ]},
    // ‚úÖ Âéü‰ª£Á†ÅÊ≠£Á°Æ
    clothes: { name: 'Êó∂Â∞öÁ©øÊê≠', theme: 'Êó•Â∏∏ÁîüÊ¥ª', img: `clothes${IMG_EXT}`, color: '#81C784', items: [
        { id: 'coa', word: 'Coat', cn: 'Â§ñÂ•ó', top: '35%', left: '22%' },
        { id: 'hat', word: 'Hat', cn: 'Â∏ΩÂ≠ê', top: '25%', left: '48%' },
        { id: 'sca', word: 'Scarf', cn: 'Âõ¥Â∑æ', top: '35%', left: '82%' },
        { id: 'bag', word: 'Backpack', cn: 'ËÉåÂåÖ', top: '70%', left: '60%' },
        { id: 'mit', word: 'Mittens', cn: 'ÊâãÂ•ó', top: '60%', left: '40%' },
        { id: 'soc', word: 'Socks', cn: 'Ë¢úÂ≠ê', top: '80%', left: '82%' },
        { id: 'boo', word: 'Boots', cn: 'Èù¥Â≠ê', top: '85%', left: '30%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÊñáÂÖ∑.png'ÔºåÊîπ‰∏∫ 'stationery.png'
    stationery: { name: 'Â∞èÂ∞èÊñáÂÖ∑Â∫ó', theme: 'Â≠¶‰π†Áî®ÂìÅ', img: `stationery${IMG_EXT}`, color: '#AB47BC', items: [
        { id: 'rul', word: 'Ruler', cn: 'Áõ¥Â∞∫', top: '85%', left: '25%' },
        { id: 'pen', word: 'Pencil', cn: 'ÈìÖÁ¨î', top: '50%', left: '18%' },
        { id: 'era', word: 'Eraser', cn: 'Ê©°ÁöÆ', top: '70%', left: '8%' },
        { id: 'not', word: 'Notebook', cn: 'Á¨îËÆ∞Êú¨', top: '30%', left: '35%' },
        { id: 'sci', word: 'Scissors', cn: 'Ââ™ÂàÄ', top: '60%', left: '85%' },
        { id: 'tap', word: 'Tape', cn: 'ËÉ∂Â∏¶', top: '87%', left: '82%' },
        { id: 'hol', word: 'Pen Holder', cn: 'Á¨îÁ≠í', top: '25%', left: '65%' },
        { id: 'ope', word: 'Notepad', cn: 'ËÆ∞‰∫ãÊú¨', top: '65%', left: '53%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÁîªÂÖ∑.png'ÔºåÊîπ‰∏∫ 'art.png'
    art: { name: 'Áº§Á∫∑ÁîªÂÆ§', theme: 'Ëâ∫ÊúØÂàõ‰Ωú', img: `art${IMG_EXT}`, color: '#26C6DA', items: [
        { id: 'buc', word: 'Bucket', cn: 'Ê∞¥Ê°∂', top: '30%', left: '22%' },
        { id: 'pal', word: 'Palette', cn: 'Ë∞ÉËâ≤Áõò', top: '70%', left: '20%' },
        { id: 'bru', word: 'Paintbrush', cn: 'ÁîªÁ¨î', top: '65%', left: '40%' },
        { id: 'apr', word: 'Apron', cn: 'Âõ¥Ë£ô', top: '70%', left: '55%' },
        { id: 'pai', word: 'Paints', cn: 'È¢úÊñô', top: '28%', left: '53%' },
        { id: 'eas', word: 'Easel', cn: 'ÁîªÊû∂', top: '45%', left: '78%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'Ëî¨Ëèú.png'ÔºåÊîπ‰∏∫ 'vegetables.png'
    vegetables: { name: 'ÂÅ•Â∫∑ËèúÁØÆÂ≠ê', theme: 'Áî∞Âõ≠Êó∂ÂÖâ', img: `vegetables${IMG_EXT}`, color: '#FF7043', items: [
        { id: 'car', word: 'Carrot', cn: 'ËÉ°ËêùÂçú', top: '45%', left: '15%' },
        { id: 'tom', word: 'Tomato', cn: 'Ë•øÁ∫¢Êüø', top: '30%', left: '35%' },
        { id: 'cuc', word: 'Cucumber', cn: 'ÈªÑÁìú', top: '45%', left: '45%' },
        { id: 'pot', word: 'Potato', cn: 'ÂúüË±Ü', top: '82%', left: '38%' },
        { id: 'pep', word: 'Green Pepper', cn: 'ÈùíÊ§í', top: '75%', left: '62%' },
        { id: 'pum', word: 'Pumpkin', cn: 'ÂçóÁìú', top: '60%', left: '85%' },
        { id: 'gre', word: 'Vegetable', cn: 'ÈùíËèú', top: '20%', left: '75%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ËÅå‰∏ö.png'ÔºåÊîπ‰∏∫ 'occupations.png'
    occupations: { name: 'ËÅå‰∏öÂ§ßÁôæÁßë', theme: 'Á§æ‰ºöÂàÜÂ∑•', img: `occupations${IMG_EXT}`, color: '#5C6BC0', items: [
        { id: 'doc', word: 'Doctor', cn: 'ÂåªÁîü', top: '45%', left: '15%' },
         { id: 'nur', word: 'Nurse', cn: 'Êä§Â£´', top: '10%', left: '75%' },
        { id: 'pol', word: 'Police', cn: 'Ë≠¶ÂØü', top: '45%', left: '82%' },
         { id: 'fir', word: 'Firefighter', cn: 'Ê∂àÈò≤Âëò', top: '35%', left: '55%' },
        { id: 'che', word: 'Chef', cn: 'Âé®Â∏à', top: '55%', left: '42%' },
         { id: 'tea', word: 'Teacher', cn: 'ËÄÅÂ∏à', top: '35%', left: '32%' },
        { id: 'wor', word: 'Worker', cn: 'Â∑•‰∫∫', top: '60%', left: '65%' },
         { id: 'stu', word: 'Student', cn: 'Â≠¶Áîü', top: '70%', left: '25%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ '‰∫§ÈÄöÂ∑•ÂÖ∑.png'ÔºåÊîπ‰∏∫ 'vehicles.png'
    vehicles: { name: 'ËΩ¶Ê∞¥È©¨Èæô', theme: '‰∫§ÈÄöÂ∑•ÂÖ∑', img: `vehicles${IMG_EXT}`, color: '#EF5350', items: [
        { id: 'bic', word: 'Bicycle', cn: 'Ëá™Ë°åËΩ¶', top: '25%', left: '18%' },
         { id: 'bus', word: 'Bus', cn: 'ÂÖ¨‰∫§ËΩ¶', top: '35%', left: '50%' },
        { id: 'amb', word: 'Ambulance', cn: 'ÊïëÊä§ËΩ¶', top: '38%', left: '82%' }, 
        { id: 'car', word: 'Car', cn: 'Ê±ΩËΩ¶', top: '60%', left: '20%' },
        { id: 'mot', word: 'Motorcycle', cn: 'Êë©ÊâòËΩ¶', top: '85%', left: '18%' }, 
        { id: 'sco', word: 'Scooter', cn: 'ÊªëÊùøËΩ¶', top: '85%', left: '45%' },
        { id: 'fit', word: 'Fire Truck', cn: 'Ê∂àÈò≤ËΩ¶', top: '80%', left: '78%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'Ê†ëÊú®.png'ÔºåÊîπ‰∏∫ 'trees.png'
    trees: { name: 'Ê£ÆÊûóÊ§çÁâ©', theme: 'Ëá™ÁÑ∂Êé¢Á¥¢', img: `trees${IMG_EXT}`, color: '#66BB6A', items: [
        { id: 'pin', word: 'Pine Tree', cn: 'ÊùæÊ†ë', top: '42%', left: '15%' }, 
        { id: 'map', word: 'Maple Leaf', cn: 'Êû´Âè∂', top: '42%', left: '38%' },
        { id: 'oak', word: 'Oak Tree', cn: 'Ê©°Ê†ë', top: '42%', left: '62%' }, 
        { id: 'bir', word: 'Birch', cn: 'Ê°¶Ê†ë', top: '40%', left: '85%' },
        { id: 'sma', word: 'Sapling', cn: 'Ê†ëËãó', top: '75%', left: '25%' },
         { id: 'big', word: 'Big Tree', cn: 'Â§ßÊ†ë', top: '75%', left: '50%' },
        { id: 'gin', word: 'Ginkgo', cn: 'Èì∂Êùè', top: '78%', left: '75%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÁêÉÁ±ª.png'ÔºåÊîπ‰∏∫ 'balls.png'
    balls: { name: 'ÁêÉÁ±ªËøêÂä®', theme: 'ÂÅ•Â∫∑ÁîüÊ¥ª', img: `balls${IMG_EXT}`, color: '#FFA726', items: [
        { id: 'bas', word: 'Basketball', cn: 'ÁØÆÁêÉ', top: '30%', left: '70%' },
         { id: 'soc', word: 'Soccer', cn: 'Ë∂≥ÁêÉ', top: '25%', left: '30%' },
        { id: 'vol', word: 'Volleyball', cn: 'ÊéíÁêÉ', top: '33%', left: '50%' }, 
        { id: 'ten', word: 'Tennis', cn: 'ÁΩëÁêÉ', top: '68%', left: '8%' },
        { id: 'rug', word: 'Rugby', cn: 'Ê©ÑÊ¶ÑÁêÉ', top: '78%', left: '35%' },
         { id: 'han', word: 'Handball', cn: 'ÊâãÁêÉ', top: '72%', left: '65%' },
        { id: 'bsb', word: 'Baseball', cn: 'Ê£íÁêÉ', top: '70%', left: '85%' }, 
        { id: 'bad', word: 'Badminton', cn: 'ÁæΩÊØõÁêÉ', top: '88%', left: '55%' },
        { id: 'pin', word: 'Ping Pong', cn: '‰πí‰πìÁêÉ', top: '82%', left: '22%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'È•ÆÂìÅ.png'ÔºåÊîπ‰∏∫ 'drinks.png'
    drinks: { name: 'ÁæéÂë≥È•ÆÂìÅ', theme: 'Ê∏ÖÂáâËß£Ê∏¥', img: `drinks${IMG_EXT}`, color: '#FFB74D', items: [
        { id: 'mil', word: 'Milk', cn: 'ÁâõÂ•∂', top: '45%', left: '10%' },
        { id: 'jui', word: 'Juice', cn: 'ÊûúÊ±Å', top: '25%', left: '26%' },
        { id: 'tea', word: 'Iced Tea', cn: 'ÂÜ∞Ëå∂', top: '65%', left: '38%' },
        { id: 'sod', word: 'Soda', cn: 'Ê±ΩÊ∞¥', top: '30%', left: '50%' },
        { id: 'cof', word: 'Coffee', cn: 'ÂíñÂï°', top: '65%', left: '60%' },
        { id: 'wat', word: 'Water', cn: 'ÁüøÊ≥âÊ∞¥', top: '20%', left: '72%' },
        { id: 'lem', word: 'Lemonade', cn: 'Êü†Ê™¨Ê∞¥', top: '45%', left: '88%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'Â∑•ÂÖ∑.png'ÔºåÊîπ‰∏∫ 'tools.png'
    tools: { name: 'ÁîüÊ¥ªÂ∑•ÂÖ∑', theme: 'Â∞èÂ∞èÂ∑•Âå†', img: `tools${IMG_EXT}`, color: '#90A4AE', items: [
        { id: 'ham', word: 'Hammer', cn: 'Èî§Â≠ê', top: '30%', left: '10%' },
        { id: 'scr', word: 'Screwdriver', cn: 'Ëû∫‰∏ùÂàÄ', top: '55%', left: '23%' },
        { id: 'saw', word: 'Saw', cn: 'ÈîØÂ≠ê', top: '40%', left: '35%' },
        { id: 'pli', word: 'Pliers', cn: 'Èí≥Â≠ê', top: '35%', left: '48%' },
        { id: 'rul', word: 'Ruler', cn: 'Â∞∫Â≠ê', top: '55%', left: '62%' },
        { id: 'nai', word: 'Screw', cn: 'Ëû∫‰∏ù', top: '70%', left: '73%' },
        { id: 'dri', word: 'Drill', cn: 'ÁîµÈíª', top: '25%', left: '86%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÂÆ∂ÂÖ∑.png'ÔºåÊîπ‰∏∫ 'furniture.png'
    furniture: { name: 'Ê∏©È¶®ÂÆ∂Âõ≠', theme: 'Êó•Â∏∏ÂÆ∂ÂÖ∑', img: `furniture${IMG_EXT}`, color: '#8D6E63', items: [
        { id: 'sof', word: 'Sofa', cn: 'Ê≤ôÂèë', top: '45%', left: '20%' },
        { id: 'lam', word: 'Lamp', cn: 'ËêΩÂú∞ÁÅØ', top: '25%', left: '46%' },
        { id: 'tv', word: 'TV', cn: 'ÁîµËßÜ', top: '30%', left: '65%' },
        { id: 'cab', word: 'Cabinet', cn: 'ÁîµËßÜÊüú', top: '55%', left: '65%' },
        { id: 'boo', word: 'Bookshelf', cn: '‰π¶Êû∂', top: '20%', left: '88%' },
        { id: 'tab', word: 'Table', cn: 'Ê°åÂ≠ê', top: '70%', left: '45%' },
        { id: 'rug', word: 'Rug', cn: 'Âú∞ÊØØ', top: '85%', left: '45%' },
        { id: 'cha', word: 'Chair', cn: 'Ê§ÖÂ≠ê', top: '75%', left: '90%' }
    ]},
    // üî¥ ‰øÆÊîπÔºöÂéü‰∏∫ 'ÂõΩÊóó.png'ÔºåÊîπ‰∏∫ 'flags.png'
    flags: { name: '‰∏ñÁïåÂõΩÊóó', theme: 'ËÆ§ËØÜÂõΩÂÆ∂', img: `flags${IMG_EXT}`, color: '#EF5350', items: [
        { id: 'ger', word: 'Germany', cn: 'Âæ∑ÂõΩ', top: '28%', left: '20%' },
        { id: 'uk', word: 'UK', cn: 'Ëã±ÂõΩ', top: '28%', left: '50%' },
        { id: 'usa', word: 'USA', cn: 'ÁæéÂõΩ', top: '28%', left: '80%' },
        { id: 'ind', word: 'India', cn: 'Âç∞Â∫¶', top: '58%', left: '20%' },
        { id: 'chn', word: 'China', cn: '‰∏≠ÂõΩ', top: '58%', left: '50%' },
        { id: 'bra', word: 'Brazil', cn: 'Â∑¥Ë•ø', top: '58%', left: '80%' },
        { id: 'can', word: 'Canada', cn: 'Âä†ÊãøÂ§ß', top: '88%', left: '20%' },
        { id: 'fra', word: 'France', cn: 'Ê≥ïÂõΩ', top: '88%', left: '50%' },
        { id: 'chi', word: 'Chile', cn: 'Êô∫Âà©', top: '88%', left: '80%' }
    ]}
};

const levelOrder = Object.keys(levels);
let currentLevelKey = '';
let mistakeCount = 0;
let hintUsed = false;
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function hexToRgba(hex, alpha) {
    let r = 0, g = 0, b = 0;
    if (hex.length === 4) {
        r = parseInt(hex[1] + hex[1], 16);
        g = parseInt(hex[2] + hex[2], 16);
        b = parseInt(hex[3] + hex[3], 16);
    } else if (hex.length === 7) {
        r = parseInt(hex.substring(1, 3), 16);
        g = parseInt(hex.substring(3, 5), 16);
        b = parseInt(hex.substring(5, 7), 16);
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// TTS ËØ≠Èü≥ÈòÖËØªÂäüËÉΩ
function speakWord(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel(); 
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-GB';
    utterance.rate = 0.75; 
    utterance.volume = 1;

    const voices = window.speechSynthesis.getVoices();
    const gbVoice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK'));
    if (gbVoice) {
        utterance.voice = gbVoice;
    }
    window.speechSynthesis.speak(utterance);
}

if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
    };
}

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    
    if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'error') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(80, now + 0.2);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'win') {
        const notes = [400, 500, 600, 800, 1000];
        notes.forEach((freq, i) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g);
            g.connect(audioCtx.destination);
            o.type = 'sine';
            o.frequency.value = freq;
            g.gain.setValueAtTime(0.1, now + i*0.1);
            g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.5);
            o.start(now + i*0.1);
            o.stop(now + i*0.1 + 0.5);
        });
    }
}

function getStars(level) {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    return data[level] || 0;
}

function getAllStarsCount() {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    return Object.values(data).reduce((acc, curr) => acc + curr, 0);
}

function saveStars(level, count) {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    if (!data[level] || count > data[level]) {
        data[level] = count;
        localStorage.setItem('wordGameProgress', JSON.stringify(data));
    }
}

window.onload = () => { renderHome(); };

function renderHome() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = ''; 
    document.getElementById('total-stars-count').innerText = getAllStarsCount();

    levelOrder.forEach(key => {
        const level = levels[key];
        const stars = getStars(key);
        const wordPreview = level.items.slice(0, 4).map(item => item.word).join(' ¬∑ ');

        const card = document.createElement('div');
        card.className = 'level-card';
        card.style.setProperty('--level-color', level.color);
        card.style.setProperty('--level-bg-alpha', hexToRgba(level.color, 0.1));
        card.onclick = () => enterGame(key);

        let starsHtml = '';
        for(let i=1; i<=3; i++) {
            starsHtml += `<svg class="rounded-star ${i <= stars ? 'earned' : ''}" viewBox="-2 -2 28 28"><path d="${ROUNDED_STAR_PATH}" />${HIGHLIGHT_CIRCLE}</svg>`;
        }

        card.innerHTML = `
            <div class="card-header-bg">
                <div class="card-header-row">
                    <h3 class="card-title">${level.name}</h3>
                    <span class="card-tag">${level.theme}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="preview-words">${wordPreview}</div>
                <div class="card-footer">
                    <div class="card-stars">${starsHtml}</div>
                    <div class="play-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });

    document.getElementById('home-view').classList.remove('hidden');
    document.getElementById('game-view').classList.add('hidden');
    document.getElementById('home-view').classList.add('fade-in');
    
    // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÂº∫Âà∂ÊªöÂä®Âà∞È°µÈù¢È°∂ÈÉ®
    window.scrollTo(0, 0);
}

function goHome() {
    document.getElementById('win-modal').style.display = 'none';
    renderHome();
}

function enterGame(key) {
    document.getElementById('home-view').classList.add('hidden');
    const gameView = document.getElementById('game-view');
    gameView.classList.remove('hidden');
    gameView.classList.add('fade-in');
    loadLevel(key);
}

function loadLevel(levelKey) {
    currentLevelKey = levelKey;
    const data = levels[levelKey];
    
    document.documentElement.style.setProperty('--current-theme', data.color);
    document.documentElement.style.setProperty('--current-theme-alpha', hexToRgba(data.color, 0.4));
    document.getElementById('level-title-display').textContent = data.name;

    mistakeCount = 0;
    hintUsed = false;
    
    const dropLayer = document.getElementById('drop-layer');
    const wordBank = document.getElementById('word-bank');
    const imgEl = document.getElementById('game-image');
    
    imgEl.style.opacity = 0;
    imgEl.src = data.img;
    imgEl.onload = () => imgEl.style.opacity = 1;
    imgEl.onerror = () => { imgEl.alt = "ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: " + data.img; imgEl.style.opacity = 1; };

    dropLayer.innerHTML = '';
    data.items.forEach(item => {
        const target = document.createElement('div');
        target.className = 'drop-target';
        target.style.top = item.top;
        target.style.left = item.left;
        target.dataset.match = item.id;
        
        target.addEventListener('dragover', e => {
            e.preventDefault();
            if(!target.classList.contains('filled')) target.classList.add('hovered');
        });
        target.addEventListener('dragleave', () => target.classList.remove('hovered'));
        target.addEventListener('drop', handleDrop);
        
        dropLayer.appendChild(target);
    });

    wordBank.innerHTML = '';
    const shuffled = [...data.items].sort(() => Math.random() - 0.5);
    shuffled.forEach(item => {
        const card = document.createElement('div');
        card.className = 'word-card';
        card.draggable = true;
        card.textContent = item.word;
        card.id = `word-${item.id}`;
        card.dataset.id = item.id;
        card.dataset.themeColor = data.color;
        
        if (item.customSpeak) {
            card.dataset.customSpeak = item.customSpeak;
        }
        
        card.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text', item.id);
            e.dataTransfer.setData('elId', card.id);
            if (audioCtx.state === 'suspended') audioCtx.resume();
        });
        
        wordBank.appendChild(card);
    });
}

function handleDrop(e) {
    e.preventDefault();
    const target = e.currentTarget;
    target.classList.remove('hovered');
    if(target.classList.contains('filled')) return;

    const droppedId = e.dataTransfer.getData('text');
    const elId = e.dataTransfer.getData('elId');
    const originalCard = document.getElementById(elId);

    if (droppedId === target.dataset.match) {
        playSound('success');
        
        target.classList.add('filled');
        target.classList.remove('hint-target');
        
        const activeCard = document.querySelector('.word-card.hint-target');
        if(activeCard) activeCard.classList.remove('hint-target');
        
        const placedCard = document.createElement('div');
        placedCard.className = 'word-card placed';
        
        const wordText = originalCard.textContent;
        const customSpeak = originalCard.dataset.customSpeak;

        placedCard.textContent = wordText;
        const themeColor = originalCard.dataset.themeColor;
        placedCard.style.backgroundColor = themeColor;
        
        if (themeColor === '#FFD54F') {
            placedCard.style.color = '#333333'; 
        } else {
            placedCard.style.color = '#FFFFFF'; 
        }
        
        target.innerHTML = '';
        target.appendChild(placedCard);
        originalCard.remove();
        
        const textToRead = customSpeak || wordText;
        setTimeout(() => {
            speakWord(textToRead);
        }, 1000);

        checkWin();
    } else {
        playSound('error');
        mistakeCount++;
        target.classList.add('wrong-shake');
        setTimeout(() => target.classList.remove('wrong-shake'), 400);
    }
}

function useHint() {
    const emptyTargets = Array.from(document.querySelectorAll('.drop-target:not(.filled)'));
    if (emptyTargets.length === 0) return;
    
    document.querySelectorAll('.hint-target').forEach(el => el.classList.remove('hint-target'));

    const target = emptyTargets[Math.floor(Math.random() * emptyTargets.length)];
    const matchId = target.dataset.match;
    const card = document.querySelector(`.word-bank .word-card[data-id="${matchId}"]`);
    
    if (target && card) {
        hintUsed = true;
        target.classList.add('hint-target');
        card.classList.add('hint-target');
        
        setTimeout(() => {
            target.classList.remove('hint-target');
            card.classList.remove('hint-target');
        }, 2000);
    }
}

function checkWin() {
    const data = levels[currentLevelKey];
    const totalItems = data.items.length;
    const filledItems = document.querySelectorAll('.drop-target.filled').length;

    if (filledItems === totalItems) {
        setTimeout(() => {
            playSound('win');
            showWinModal();
        }, 2500); 
    }
}

function showWinModal() {
    const modal = document.getElementById('win-modal');
    const stars = [
        document.getElementById('star-1'),
        document.getElementById('star-2'),
        document.getElementById('star-3')
    ];
    const heading = document.getElementById('modal-heading');
    const msg = document.getElementById('modal-msg');
    
    stars.forEach(s => s.classList.remove('active'));
    
    let starCount = 0;
    if (hintUsed) {
        starCount = 1;
        heading.innerText = "ÂÆåÊàêÊåëÊàò!";
        msg.innerText = "‰ΩøÁî®‰∫ÜÊèêÁ§∫Ôºå‰∏ãÊ¨°ËØïËØïÈù†Ëá™Â∑±ÔºÅ";
    } else if (mistakeCount === 0) {
        starCount = 3;
        heading.innerText = "ÂÆåÁæéÈÄöÂÖ≥!";
        msg.innerText = "Â§™Ê£í‰∫ÜÔºÅÁôæÂèëÁôæ‰∏≠ÔºÅ";
    } else if (mistakeCount <= 2) {
        starCount = 2;
        heading.innerText = "ÂÅöÂæó‰∏çÈîô!";
        msg.innerText = "Â∑ÆÁÇπÂ∞±Êª°ÂàÜ‰∫ÜÔºåÂä†Ê≤πÔºÅ";
    } else {
        starCount = 1;
        heading.innerText = "ÈóØÂÖ≥ÊàêÂäü!";
        msg.innerText = "ÁªßÁª≠Âä†Ê≤πÔºå‰Ω†‰ºöÊõ¥Ê£íÁöÑÔºÅ";
    }

    saveStars(currentLevelKey, starCount);

    const listContainer = document.getElementById('level-word-list');
    listContainer.innerHTML = ''; 
    
    const currentData = levels[currentLevelKey];
    if (currentData && currentData.items) {
        currentData.items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'word-list-item';
            const cnText = item.cn || ''; 
            row.innerHTML = `<span class="word-en">${item.word}</span><span class="word-cn">${cnText}</span>`;
            listContainer.appendChild(row);
        });
    }

    modal.style.display = 'flex';
    for(let i=0; i<starCount; i++) {
        setTimeout(() => {
            stars[i].classList.add('active');
        }, i * 200 + 300);
    }
}

function nextLevel() {
    document.getElementById('win-modal').style.display = 'none';
    let currentIndex = levelOrder.indexOf(currentLevelKey);
    let nextIndex = currentIndex + 1;
    
    if (nextIndex >= levelOrder.length) {
        alert("ÊÅ≠Âñú‰Ω†ÔºåÈÄöÂÖ≥‰∫ÜÊâÄÊúâÂú∫ÊôØÔºÅ");
        goHome();
    } else {
        loadLevel(levelOrder[nextIndex]);
    }
}
</script>
</body>
</html>
